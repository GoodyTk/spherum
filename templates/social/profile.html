{% load static %}

{% block content %}
<div class="profile-container">
    <div class="profile-info">
        <img src="{{ user.profile.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="profile-avatar">
        <h1>–ü—Ä–æ—Ñ–∏–ª—å {{ user.username }}</h1>
        <p><strong>–ò–º—è:</strong> {{ user.first_name }} {{ user.last_name }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>

        <h2 class="section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h2>
        <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:</strong> {{ profile.created_at }}</p>
        <p><strong>–ë–∏–æ–≥—Ä–∞—Ñ–∏—è:</strong> {{ profile.bio }}</p>
        <p><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> {{ profile.birth_date }}</p>
        <p>
            {% if user.profile.is_online %}
                üü¢ –û–Ω–ª–∞–π–Ω
            {% else %}
                üî¥ –û—Ñ–ª–∞–π–Ω (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: {{ user.profile.last_seen|date:"d.m.Y H:i" }})
            {% endif %}
        </p>
    </div>

    <div class="buttons">
        <a href="/" class="btn btn-secondary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        {% if request.user == user %}
            <a href="{% url 'edit_profile' username=user.username %}" class="btn btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>
            <a href="{% url 'create_post' %}" class="btn btn-success">–°–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é</a>
            <a href="{% url 'create_poll' %}" class="btn btn-success">–°–æ–∑–¥–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</a> 
            <a href="{% url 'friends_list' %}" class="btn btn-success">My Friends</a>
        {% else %}
            {% if user in request.user.profile.friends.all %}
                <a href="{% url 'remove_friend' user.id %}" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π</a>
            {% elif sent_request_exists %}
                <span class="text-muted">–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>
            {% else %}
                <a href="{% url 'send_friend_request' user.id %}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</a>
            {% endif %}
        {% endif %}
    </div>

    <div class="profile-container">
        {% if user != request.user %}
            <div class="buttons">
                {% if is_following %}
                    <a href="{% url 'unfollow_user' user.id %}" class="btn" style="background-color: #f44336;">Unfollow</a>
                {% else %}
                    <a href="{% url 'follow_user' user.id %}" class="btn" style="background-color: #4CAF50;">Follow</a>
                {% endif %}
            </div>
        {% endif %}
    
        <div class="buttons">
            <a href="{% url 'followers_list' user.id %}" class="btn" style="background-color: #2196F3;">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</a>
            <a href="{% url 'following_list' user.id %}" class="btn" style="background-color: #2196F3;">–ü–æ–¥–ø–∏—Å–∫–∏</a>
        </div>
    </div>
    
    

    {% if request.user == user %}
    <h2 class="section-title">–í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è</h2>
    {% for req in request.user.received_requests.all %}
        <div class="request">
            <p>–ó–∞–ø—Ä–æ—Å –æ—Ç {{ req.from_user.username }}</p>
            <button class="btn btn-success accept-btn" data-request-id="{{ req.id }}" data-request-url="{% url 'accept_friend_request' req.id %}">–ü—Ä–∏–Ω—è—Ç—å</button>
            <button class="btn btn-danger decline-btn" data-request-id="{{ req.id }}" data-request-url="{% url 'decline_friend_request' req.id %}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>
    {% endfor %}
    {% endif %}

    <h2 class="section-title">–ú–æ–∏ –æ–ø—Ä–æ—Å—ã</h2>
    <ul class="poll-list">
        {% for poll in user.polls.all %}
            <li>
                <center><a href="{% url 'poll_detail' poll.id %}" class="poll-link">{{ poll.question }}</a></center> <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø—Ä–æ—Å–∞ -->
            </li>
        {% endfor %}
    </ul>

    <h2 class="section-title">–ü—É–±–ª–∏–∫–∞—Ü–∏–∏</h2>
    {% for post in user.posts.all %}
        <div class="post">
            <p class="post-title"><strong>{{ post.author.username }}</strong> ({{ post.created_at|date:"d.m.Y H:i" }})</p>
            <p class="post-content">{{ post.content }}</p>

            {% if post.image %}
                <img src="{{ post.image.url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞" class="post-image">
            {% endif %}

            {% if request.user == post.author %}
                <form action="{% url 'delete_post' post.id %}" method="post" class="delete-form">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
            {% endif %}

            <div class="like-section">
                <form method="post" action="{% url 'post-like-toggle' post.id %}" class="like-form" id="like-form-{{ post.id }}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm {% if request.user in post.post_likes.all %}btn-success{% else %}btn-outline-success{% endif %}" id="like-btn-{{ post.id }}">
                        –õ–∞–π–∫ {{ post.post_likes.count }}
                    </button>
                </form>
            </div>

            <div class="comment-actions">
                <button id="toggle-comments-btn-{{ post.id }}" class="btn btn-info" onclick="toggleComments({{ post.id }})">–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
                <form method="post" action="{% url 'post_detail' post.id %}" class="comment-form">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                </form>
            </div>

            <div id="comments-section-{{ post.id }}" style="display:none;">
                {% for comment in post.comments.all %}
                    <div class="comment">
                        <p><strong>{{ comment.author.username }}</strong> ({{ comment.created_at|date:"d.m.Y H:i" }})</p>
                        <p>{{ comment.content }}</p>
            
                        <form action="{% url 'comment-like-toggle' comment.id %}" method="post" class="like-form" id="like-form-{{ comment.id }}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm {% if request.user in comment.comment_likes.all %}btn-success{% else %}btn-outline-success{% endif %}" id="like-btn-{{ comment.id }}">
                                –õ–∞–π–∫ {{ comment.comment_likes.count }}
                            </button>
                        </form>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
</div>

<script>
    function toggleComments(postId) {
        const commentsContainer = document.getElementById(`comments-section-${postId}`);
        const toggleButton = document.getElementById(`toggle-comments-btn-${postId}`);
        
        if (commentsContainer.style.display === "none") {
            commentsContainer.style.display = "block";
            toggleButton.textContent = "–°–∫—Ä—ã—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏";
        } else {
            commentsContainer.style.display = "none";
            toggleButton.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

    function sendFriendRequest(button) {
        fetch(button.dataset.requestUrl, {
            method: 'GET',
            headers: { 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                button.textContent = button.classList.contains('accept-btn') ? "–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç" : "–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—ë–Ω";
                button.disabled = true;
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞");
            }
        })
        .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞:", error));
    }

    document.querySelectorAll('.accept-btn, .decline-btn').forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault();
            sendFriendRequest(this);
        });
    });
});


</script>

{% endblock %}

<style>
    body {
        background-color: #f2f2f2;
        color: #333;
        font-family: Arial, sans-serif;
    }

    .profile-container {
        width: 80%;
        max-width: 1000px;
        margin: 20px auto;
        padding: 20px;
        background: #2e2e2e;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .profile-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 30px;
    }

    .profile-avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #4CAF50;
        margin-bottom: 20px;
    }

    h1 {
        font-size: 2.5rem;
        color: #f1f1f1;
        margin-bottom: 20px;
        text-align: center;
    }

    h2.section-title {
        font-size: 1.8rem;
        font-weight: bold;
        color: #fff;
        margin-top: 30px;
        text-align: center;
    }

    p {
        color: #d1d1d1;
        font-size: 1.2rem;
        margin: 5px 0;
    }

    .buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        font-size: 1rem;
        color: white;
        background-color: #4CAF50;
        border: none;
    }

    .btn:hover {
        background-color: #45a049;
    }

    .post {
        background-color: #fff;
        padding: 15px;
        margin-top: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .post-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }

    .post-content {
        font-size: 1.2rem;
        color: #444;
        margin-bottom: 20px;
    }

    .post img {
        max-width: 100%;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .like-section, .comment-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 10px;
    }

    .comment {
        background-color: #fafafa;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
    }

    .poll-list {
        padding-left: 0;
        list-style-type: none;
        margin-top: 10px;
    }

    .poll-link {
        color: #4CAF50;
        text-decoration: none;
        font-size: 1.2rem;
    }

    .poll-link:hover {
        text-decoration: underline;
    }
</style>
